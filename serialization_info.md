**Конспект: Сериализация в Java**

1.  **Определения:**
    *   **Сериализация:** Процесс записи состояния объекта в поток байт.
    *   **Десериализация:** Процесс чтения/восстановления объекта из потока байт.

2.  **Основные классы и методы:**
    *   `ObjectOutputStream`: Записывает объекты (метод `writeObject(Object obj)`). Реализует `ObjectOutput` (наследует `DataOutput` для примитивов).
    *   `ObjectInputStream`: Считывает объекты (метод `readObject()`). Реализует `ObjectInput` (наследует `DataInput` для примитивов). `readObject()` возвращает `Object`, требует приведения типа.

3.  **Требования к классам:**
    *   Объект может быть сериализован/десериализован, только если его класс реализует `java.io.Serializable` (интерфейс-маркер) или `java.io.Externalizable`.

4.  **Что сериализуется/десериализуется:**
    *   Сам объект и все объекты, на которые он ссылается (если они реализуют нужный интерфейс).
    *   Ссылки на один и тот же объект записываются эффективно (сам объект пишется один раз).
    *   Строки и массивы (т.к. они объекты).
    *   Примитивные типы (через методы `DataOutput`/`DataInput`).

5.  **Что НЕ сериализуется:**
    *   Поля, объявленные как `static`.
    *   Поля, объявленные как `transient`.

6.  **Процесс десериализации:**
    *   Всегда создаются **новые** объекты.
    *   Память выделяется, заполняется нулями.
    *   Вызываются конструкторы **по умолчанию** для не-сериализуемых суперклассов.
    *   Поля сериализуемых классов считываются из потока (от суперкласса к подклассу).

7.  **Кастомизация (для `Serializable`):**
    *   Класс может определить приватные методы для особой обработки:
        *   `private void writeObject(ObjectOutputStream stream)`: Управляет записью состояния.
        *   `private void readObject(ObjectInputStream stream)`: Управляет чтением состояния.
        *   `private void readObjectNoData()`: Инициализирует объект, если в потоке нет данных для его суперкласса (из-за несовпадения версий или подделки потока).

8.  **Полный контроль (`Externalizable`):**
    *   Класс должен реализовать методы `writeExternal(ObjectOutput out)` и `readExternal(ObjectInput in)`.
    *   Класс полностью отвечает за формат данных и обработку версий.

9.  **Перечисления (Enum):**
    *   Особая сериализация: записывается только имя константы.
    *   Десериализация использует `Enum.valueOf(Class, String)`.
    *   Процесс нельзя кастомизировать (методы `readObject` и др. игнорируются).
    *   Фиксированный `serialVersionUID = 0L`.

10. **Версионирование (`serialVersionUID`):**
    *   Поле `static final long serialVersionUID`.
    *   Определяет версию класса для проверки совместимости при десериализации.
    *   Если `serialVersionUID` в потоке и у класса не совпадают -> `InvalidClassException`.
    *   **Крайне рекомендуется объявлять вручную**, т.к. авто-генерация ненадежна и зависит от платформы/компилятора.

11. **Подмена объекта:**
    *   Метод `writeReplace()`: Вызывается при сериализации, позволяет записать другой объект вместо текущего.
    *   Метод `readResolve()`: Вызывается после десериализации, позволяет вернуть другой объект вместо только что созданного.
